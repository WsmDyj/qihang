## å‰è¨€
ä¸€è½¬çœ¼ä¹æœˆåˆè¿‡å»äº†ï¼Œæœ€è¿‘æ²¡æ€ä¹ˆå†™åšå®¢æ˜¯å› ä¸ºäº‹æƒ…å¤ªå¤šäº†ï¼Œæ„Ÿè§‰å¿ƒä¸€ç›´åœ¨è·¯ä¸Šï¼Œä»æ¥æ²¡æœ‰æ—¶é—´åœä¸‹æ¥æ –æ¯ã€‚ä»æ¯•ä¸šåˆ°ç°åœ¨ï¼Œåˆšå…¥èŒä¾¿è¢«å¤§é‡çš„ä¸šåŠ¡éœ€æ±‚æ‰€å›´ç»•ã€‚çœ‹åˆ°æ’æœŸå·²ç»æ’åˆ°æ˜å¹´çš„æ—¶å€™æˆ‘é™·å…¥äº†æ²‰æ€ï¼Œæ›¾å¹»æƒ³ç€åˆ©ç”¨å·¥ä½œä¹‹ä½™çš„æ—¶é—´åšä¸€äº›è‡ªå·±å–œæ¬¢åšçš„äº‹ã€‚æ…¢æ…¢çš„å‘ç°å¼±å°çš„èº«ä½“æ ¹æœ¬æ”¯æ’‘ä¸ä½ã€‚å¾ˆæ—©ä¹°çš„ã€Šæ·±å…¥æµ…å‡ºnode.jsã€‹ç¿»çœ‹çš„æ¬¡æ•°ä¹Ÿå¯¥å¯¥æ— å‡ ï¼Œæ¯å½“æƒ³åˆ°è¿™äº›è„¸ä¸Šæ€»ä¼šå¸¦ç€ä¸€ä¸æƒ†æ€…ã€‚å¹¸è¿çš„æ˜¯æˆ‘ä»¬è€æ¿å¯Ÿè§‰å‡ºæ¥äº†æˆ‘çš„å¿§æ„ï¼Œæ”¾äº†åŠå¤©å‡è®©æˆ‘çœ‹çœ‹ä¹¦ã€‚äºæ˜¯ä¾¿æœ‰æœºä¼šå¯ä»¥çœ‹çœ‹nodeæ–¹é¢çš„ä¹¦ç±ã€‚çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œäº†è§£å¤§æ¦‚çš„nodeåŸºç¡€çŸ¥è¯†åè ¢è ¢æ¬²åŠ¨ï¼Œé‚£ä¹ˆè·Ÿç€æˆ‘ä¸€èµ·å­¦ä¹ ä¸€ä¸‹å§ï¼
## æœ¬ç¯‡ä½ èƒ½å­¦åˆ°ä»€ä¹ˆ
- [x] æ¥å£ï¼ŒåŒ…æ‹¬node.jså¤„ç†httpè¯·æ±‚ã€æ­å»ºå¼€å‘ç¯å¢ƒã€å¤„ç†è·¯ç”±ã€å¼€å‘å„ä¸ªæ¥å£
- [x] æ•°æ®å­˜å‚¨ï¼ŒMySqlå»ºåº“å»ºè¡¨ã€Nodeé“¾æ¥MySqlã€æ¥å£å¯¹æ¥Mysql
- [x] ç™»å½•ï¼Œcookieå’Œsessionã€ä½¿ç”¨Rediså­˜å‚¨Session
- [x] Ngnixé…ç½®ï¼Œå‰åç«¯è”è°ƒ
- [x] æ—¥å¿—ï¼ŒNode.jsæ–‡ä»¶æ“ä½œã€stream æµã€æ—¥å¿—åŠŸèƒ½çš„å¼€å‘ã€æ—¥å¿—æ–‡ä»¶æ‹†åˆ†ã€æ—¥å¿—åˆ†æ
- [x] å®‰å…¨ï¼Œé¢„é˜²SQLã€XSSæ”»å‡»
- [x] Expressæ¡†æ¶ï¼Œä¸­é—´ä»¶å®ç°åŸç†ã€å¼€å‘apiæ¥å£ã€ç»“åˆå¸¸ç”¨æ’ä»¶
- [x] koa2æ¡†æ¶ï¼Œ
- [x] çº¿ä¸Šéƒ¨ç½²ï¼ŒPM2 ä»‹ç»å’Œé…ç½®ã€PM2 å¤šè¿›ç¨‹æ¨¡å‹
![éœ€æ±‚åˆ†æ](https://user-gold-cdn.xitu.io/2019/9/19/16d47b515b0c3536?w=1926&h=976&f=png&s=316031)

## ä¸€ã€åšå®¢é¡¹ç›®ä¹‹æ¥å£
è¦å¼€å‘ä¸€ä¸ªåšå®¢é¡¹ç›®çš„ server ç«¯ï¼Œé¦–å…ˆè¦å®ç°æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡ä¸­çš„å„ä¸ª APIã€‚æœ¬ç« ä¸»è¦è®²è§£å¦‚ä½•ä½¿ç”¨åŸç”Ÿ nodejs å¤„ç†çš„ http è¯·æ±‚ï¼ŒåŒ…æ‹¬è·¯ç”±åˆ†æå’Œæ•°æ®è¿”å›ï¼Œç„¶åä»£ç æ¼”ç¤ºå„ä¸ªAPIçš„å¼€å‘ã€‚ä½†æ˜¯æœ¬ç« å°šæœªè¿æ¥æ•°æ®åº“ï¼Œå› æ­¤ API è¿”å›çš„éƒ½æ˜¯å‡æ•°æ®ã€‚

### 1. å·¥å…·å‡†å¤‡
* ä½¿ç”¨nodemon æ£€æµ‹æ–‡ä»¶å˜åŒ–ï¼Œè‡ªåŠ¨é‡å¯node
* ä½¿ç”¨cross-env è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå…¼å®¹mac linux å’Œwindow
> npm install nodemon cress-env -d --save

æ–°å»ºä¸€ä¸ªé¡¹ç›®ånode-blogçš„æ–‡ä»¶ï¼Œç”¨npm init -y åˆå§‹åŒ–é¡¹ç›®ã€‚å¹¶åœ¨package.jsoné…ç½®script,ä½¿ç”¨ npm run dev å¯åŠ¨æˆ‘ä»¬çš„é¡¹ç›®
```
"dev": "cross-env NODE_ENV=dev nodemon ./bin/api.js",
"prd": "cross-env NODE_ENV=production nodemon ./bin/api.js"
```
### 2. æ¨¡å—åŒ–--ç›®å½•ä»‹ç»
```
.node-blog
â”œâ”€â”€ bin // é¡¹ç›®å¯åŠ¨æ–‡ä»¶
â”œâ”€â”€ node_modules
â”œâ”€â”€ src
|   â”œâ”€â”€ conf // æ•°æ®åº“é…ç½®
|   â””â”€â”€ controller // æ¥å£api
|   â””â”€â”€ db // æ•°æ®åº“é“¾æ¥
|   â””â”€â”€ model // è¾“å‡ºæ ¼å¼
|   â””â”€â”€router // è·¯ç”±
â”œâ”€â”€ app.js
â”œâ”€â”€ package.json

```
### 3. é¡¹ç›®å¼€å‘
ğŸ‘‰åœ¨binä¸‹æ–°å»ºä¸€ä¸ªapi.jsä½œä¸ºnodeå¯åŠ¨ä¸€ä¸ªæœåŠ¡çš„æ¨¡å—
```
const http = require('http')
const serverHandle = require('../app')

const PORT = 8000

const server = http.createServer(serverHandle)

server.listen(PORT)
```

ğŸ‘‰app.jsä¸­åˆ›å»ºæˆ‘ä»¬çš„é…ç½®æœåŠ¡é…ç½®ï¼š
```
const serverHandle = (req, res) => {
    // è®¾ç½®è¿”å›æ ¼å¼ JSON
    res.setHeader('Content-type', 'application/json')
}
module.exports = serverHandle
```
ğŸ‘‰ åœ¨routerä¸­åˆ›å»ºblog.jsã€user.jsæ–‡ä»¶ï¼Œå…¶ä¸­blog.jsä½œä¸ºåšå®¢çš„è·¯ç”±ï¼Œè¿™é‡Œä»¥è·å–åšå®¢åˆ—è¡¨çš„æ¥å£ä¸ºä¾‹ï¼Œå…¶ä»–çš„æ¥å£åªæ˜¯æ¢äº†ä¸€ä¸ªåå­—è€Œå·²ï¼š
```
const handleBlogRouter = (req, res) => {
  const method = req.method // GET POST
  const url = req.url
  const path = url.split('?')[0]
  // è·å–åšå®¢åˆ—è¡¨
  if (method === 'GET' && req.path === '/api/blog/list') {
    return {
        msg: 'è¿™æ˜¯è·å–åšå®¢åˆ—è¡¨çš„æ¥å£'
    }
  }
}

module.exports = handleBlogRouter
```
ğŸ‘‰ åœ¨app.jsä¸­å¼•ç”¨åˆ›å»ºçš„è·¯ç”±
```
const handleBlogRouter = require('./src/router/blog')
const handelUserRouter = require('./src/router/user')
const serverHandle = (req, res) => {
    // è®¾ç½®è¿”å›æ ¼å¼ JSON
    res.setHeader('Content-type', 'application/json')
    // å¤„ç† blog è·¯ç”±
    const blogData = handleBlogRouter(req, res) => {
        if (blogData) {
            res.end(JSON.stringify(blogData)
            return 
        }
    }
    // å¤„ç† user è·¯ç”±
    const userData = handleUserRouter(req, res) => {
        if (userData) {
            res.end(JSON.stringify(userData)
            return 
        }
    }
    // 404
    res.writeHead(404, {"Content-type": "text/plain"})
    res.write("404 Not Found\n")
    res.end()
}
module.exports = serverHandle
```
è¿™é‡Œå¯åŠ¨æˆ‘ä»¬çš„æœåŠ¡ï¼Œè¾“å…¥å¯¹åº”çš„æ¥å£apiï¼Œå°±èƒ½æ‹¿åˆ°æˆ‘ä»¬è¿”å›çš„å‡æ•°æ®äº†ã€‚å…³äºè¯¦ç»†çš„æ¥å£å¼€å‘ã€‚åœ¨controllerä¸­æ–°å»ºblog.jsã€user.jså¤„ç†ï¼Œè¿™é‡Œå°±ä¸å±•å¼€ã€‚è¯¦ç»†å¯æŸ¥çœ‹[æ¥å£å¼€å‘](https://github.com/WsmDyj/node-blog/tree/master/blog-node/src/controller)
## äºŒã€åšå®¢é¡¹ç›®ä¹‹æ•°æ®å­˜å‚¨
API å®ç°äº†ï¼Œå°±éœ€è¦è¿æ¥æ•°æ®åº“ï¼Œå®ç°çœŸæ­£çš„æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢ï¼Œä¸å†ä½¿ç”¨å‡æ•°æ®ã€‚æœ¬ç« ä¸»è¦è®²è§£ mysql çš„å®‰è£…ã€ä½¿ç”¨ï¼Œä»¥åŠç”¨ nodejs è¿æ¥ mysql ï¼Œæœ€åå°† mysql åº”ç”¨åˆ°å„ä¸ªå·²ç»å¼€å‘å®Œçš„ API ä¸­ã€‚

ä¸ºäº†é™ä½æœ¬å¹…çš„ç¯‡é•¿ï¼Œè¿™é‡Œå°†çœç•¥å¦‚ä½•å®‰è£…mysql,å…¶å®æ­¥éª¤å¾ˆç®€å•ï¼Œä¹Ÿä¸æ˜¯æœ¬æ–‡çš„ä¸»è¦è®²è§£ç‚¹ï¼Œè¿™é‡Œæ‰¾äº†ä¸€ä¸ªè¿˜ä¸é”™çš„å®‰è£…æ•™ç¨‹ï¼Œå¯ä»¥ä¾›å¤§å®¶å‚è€ƒï¼š[mysqlå®‰è£…æ•™ç¨‹](https://zhuanlan.zhihu.com/p/37152572),å¦å¤–ä¸ä¹ æƒ¯æ“ä½œæ§åˆ¶å°çš„å¯ä»¥è‡ªè¡Œä¸‹ä¸ªå›¾å½¢åŒ–ç•Œé¢ã€‚æˆ‘ç”¨çš„æ˜¯MySql Workbenchã€‚

### 1. åˆ›å»ºæ•°æ®åº“å’Œæ•°æ®è¡¨
*  åˆ©ç”¨MySql Workbenchåˆ›å»ºmyBlogæ•°æ®åº“ï¼Œåœ¨æ­¤æ•°æ®åº“ä¸‹åˆ›å»ºblogsã€usersä¸¤å¼ æ•°æ®è¡¨ï¼Œåˆ†åˆ«å­˜å‚¨åšå®¢å’Œç”¨æˆ·ç™»å½•æ•°æ®
* blogsè¡¨åˆ›å»ºä»¥è‡ªå¢idä½œä¸ºä¸»é”®ï¼Œtitleã€contnetã€createtimeã€authorå…±5ä¸ªå­—æ®µï¼›usersè¡¨åˆ›å»ºä¹Ÿä»¥è‡ªå¢idä½œä¸ºä¸»é”®ï¼Œusernameã€passwordã€realnameå…±å››ä¸ªå­—æ®µï¼›ä¸‹å›¾ä¸ºblogså’Œusersæ•°æ®è¡¨å„å­—æ®µçš„ç»“æ„ï¼š ![blogsè¡¨](https://user-gold-cdn.xitu.io/2019/9/16/16d38d5f8f343887?w=1120&h=284&f=jpeg&s=168924)
![usersè¡¨](https://user-gold-cdn.xitu.io/2019/9/16/16d38d78f33b25e6?w=1102&h=232&f=jpeg&s=142522)
### 2. nodeè¿æ¥æ•°æ®åº“
* åœ¨é¡¹ç›®ä¸­å®‰è£…mysqlã€‚> npm install mysql
* åœ¨dbç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªmysql.jsã€‚ç”¨äºè¿æ¥mysql
```
const mysql = require('mysql')

// åˆ›å»ºé“¾æ¥å¯¹è±¡
const con = mysql.createConnection(
  {
    host: 'localhost',
    user: 'root',
    password: '123456',
    port: '3306',
    database: 'myblog'
  }
)

// å¼€å§‹é“¾æ¥
con.connect()

// æ‰§è¡Œsqlè¯­å¥çš„å‡½æ•°
function exec(sql) {
  const promise = new Promise((resolve, reject) => {
    con.query(sql, (err, result) => {
      if (err) {
        reject(err)
        return
      }
      resolve(result)
    })  
  })
  return promise
}

module.exports = {
  exec
}
```
### 3. æ¥å£å¯¹æ¥Mysql
åœ¨ä¸Šç« ä¸­è®²åˆ°çš„å‡æ•°æ®æ›¿æ¢æˆæ•°æ®åº“ä¸­çš„çœŸå®æ•°æ®ã€‚åœ¨controllerç›®å½•ä¸‹çš„blogã€userå¼•å…¥åˆšåˆ›å»ºçš„mysql.jsã€‚åœ¨å„æ¥å£å®Œæˆmysqlè¯­å¥å®Œæˆæ¥å£å¯¹æ¥mysqlã€‚æ‰€æœ‰çš„æ¥å£éƒ½æ˜¯ä¸€æ ·çš„å¤„ç†ï¼Œåªæ˜¯æ‰§è¡Œçš„sqlè¯­å¥ä¸ä¸€æ ·ï¼Œè¯¦ç»†å¯æŸ¥çœ‹[å„æ¥å£å¯¹æ¥Mysql](https://github.com/WsmDyj/node-blog/tree/master/blog-node/src/controller)ï¼Œè¿™é‡Œä»¥è·å–æ•°æ®åˆ—è¡¨çš„æ¥å£ä¸ºä¾‹ï¼š
```
const getList = (author, keyworld) => {
  let sql = `select * from blogs where 1=1 `
  if (author) {
    sql += `and author = '${author}' `
  }
  if (keyworld) {
    sql += `and title like '%${keyworld}%' `
  }
  sql += `order by createtime desc;` 
  return exec(sql)
}
```
## ä¸‰ã€åšå®¢é¡¹ç›®ä¹‹ç™»å½•
### 1. cookieåšé™åˆ¶
è®¾ç½®ç”¨æˆ·åçš„cookie, å…¶ä¸­getCookieExpiresä¸ºcookieçš„è¿‡æœŸæ—¶é—´ï¼Œ path=/ è®¾ç½®æ‰€æœ‰è·¯ç”±ï¼ŒhttpOnlyä¸å…è®¸å‰ç«¯æ›´æ”¹cookieã€‚
> res.setHeader('Set-Cookie', `username=${username}; path=/; httpOnly; expires=${getCookieExpires()}`)

æ­¥éª¤ï¼šè®¿é—®loginï¼Œå°†ç”¨æˆ·åå¯†ç ä¼ è¿‡å»ï¼ŒéªŒè¯ç™»å½•ï¼Œç™»å½•ä¹‹åå°†ç”¨æˆ·ä¿¡æ¯å†™å…¥åˆ°cookieè¿”å›å‰ç«¯ã€‚é€šè¿‡cookieæµ‹è¯•åˆ¤æ–­æœ‰æ— ç™»å½•ã€‚
```
// è§£æcookie 
  req.cookie = {}
  const cookiestr = req.headers.cookie || ''
  cookiestr.split(';').forEach(item => {
    if (!item) {
      return
    }
    const arr = item.split('=')
    const key = arr[0].trim()
    const val = arr[1].trim()
    req.cookie[key] = val
  })
```
## å››ã€åšå®¢é¡¹ç›®ä¹‹æ—¥å¿—
æ—¥å¿—è®°å½•å’Œæ—¥å¿—åˆ†ææ˜¯ server ç«¯çš„é‡è¦æ¨¡å—ï¼Œå‰ç«¯æ¶‰åŠè¾ƒå°‘ã€‚æœ¬ç« ä¸»è¦è®²è§£å¦‚ä½•ä½¿ç”¨åŸç”Ÿ nodejs å®ç°æ—¥å¿—è®°å½•ã€æ—¥å¿—å†…å®¹åˆ†æå’Œæ—¥å¿—æ–‡ä»¶æ‹†åˆ†ã€‚å…¶ä¸­åŒ…æ‹¬ stream readline å’Œ crontab ç­‰æ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚
### 1. streamä»‹ç»å’Œä½¿ç”¨
ä»€ä¹ˆæ˜¯stream?   ğŸ‘‰[å®˜æ–¹è§£é‡Š](http://nodejs.cn/api/stream.html)
> æµï¼ˆstreamï¼‰æ˜¯ Node.js ä¸­å¤„ç†æµå¼æ•°æ®çš„æŠ½è±¡æ¥å£ã€‚ stream æ¨¡å—ç”¨äºæ„å»ºå®ç°äº†æµæ¥å£çš„å¯¹è±¡ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„(Readable)ã€å¯å†™çš„(Writable)ã€æˆ–è€…å¯è¯»å¯å†™çš„(Duplex)ã€‚æŠ½è±¡ç†è§£ä¸ºä¸¤ä¸ªæ°´æ¡¶é€šè¿‡æ°´ç®¡é“¾æ¥ï¼Œå°†å…¶ä¸­çš„ä¸€ä¸ªæ°´æ¡¶çš„æ°´æ»¡æ»¡æµå…¥åˆ°å¦ä¸€ä¸ªæ°´æ¡¶ã€‚

streamèƒ½åšä»€ä¹ˆï¼Ÿ ğŸ‘‰ IOï¼ˆç½‘ç»œIOå’Œæ–‡ä»¶IOï¼‰æ“ä½œçš„æ€§èƒ½ç“¶é¢ˆï¼Œå¦‚ä½•åœ¨æœ‰é™çš„ç¡¬ä»¶èµ„æºä¸‹æé«˜IOçš„æ“ä½œæ•ˆç‡ã€‚


stream(æµ) æ‹·è´ä»£ç æ¼”ç¤º ï¼š
```
const fs = require('fs')
const path= require('path')
// ä¸¤ä¸ªæ–‡ä»¶å
const fileName1 = path.resolve(__dirname, 'data.txt')
const fileName2 = path.resolve(__dirname, 'data-bak.txt')
// è¯»å–æ–‡ä»¶çš„ stream å¯¹è±¡
const readStream = fs.createReadStream(fileName1)
// å†™å…¥æ–‡ä»¶çš„ stream å¯¹è±¡
const writeStream = fs.createWriteStream(fileName2)
// æ‰§è¡Œæ‹·è´ï¼Œé€šè¿‡pipe
readStream.pipe(writeStream)
// ç›‘å¬æ¯æ¬¡æ‹·è´çš„å†…å®¹
readStream.on('data', chunk => {
  console.log(chunk.toString())
})
// æ•°æ®è¯»å–å®Œæˆï¼Œå³æ‹·è´å®Œæˆ
readStream.on('end', () => {
  console.log('copy done')
})
```

### 2.å†™æ—¥å¿—
åœ¨blog-nodeçš„ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªlogsæ–‡ä»¶å¤¹,åœ¨å…¶ä¸‹é¢æ–°å»ºaccess.logã€error.logã€event.logã€‚å¹¶åœ¨srcä¸‹æ–°å»ºä¸€ä¸ªutils > log.js è¿™é‡Œå°±ä»¥accessä¸ºä¾‹å­ï¼Œå…¶ä»£ç ä¸ºï¼š
```
const fs = require('fs')
const path = require('path')

// å†™æ—¥å¿—
function writeLog (writeStream, log) {
  writeStream.write(log + '\n')
}

// ç”Ÿæˆ write stream
function createWriteStream (fileName) {
  const fullFileName = path.join(__dirname, '../', '../', 'logs', fileName)
  const writeStream = fs.createWriteStream(fullFileName, {
    flags: 'a'
  })
  return writeStream
}

// å†™è®¿é—®æ—¥å¿—
const accessWriteStream = createWriteStream('access.log')
function access (log) {
  writeLog(accessWriteStream, log)
}

module.exports = {
  access
}
```
åœ¨app.jsä¸­å¼•å…¥åˆšå†™çš„log.jsæ–‡ä»¶ä¸­accessæ–¹æ³•å¹¶åœ¨serverHandleæ–¹æ³•ä¸­è®°å½•access logã€‚å½“æˆ‘ä»¬çš„æ¥å£è¢«æ‰§è¡Œçš„æ—¶å€™å°±ä¼šè®°å½•æ¥å£çš„ä¿¡æ¯ç­‰ã€‚
> access(`${req.method} -- ${req.url} -- ${req.headers['user-agent']} -- ${Date.now()}`)

### 3.æ—¥å¿—æ‹†åˆ†
* æŒ‰æ—¶é—´åˆ’åˆ†æ—¥å¿—æ–‡ä»¶ï¼Œå¦‚2019-09-18.access.log
* å®ç°æ–¹å¼ï¼šlinuxçš„crontabå‘½ä»¤ï¼Œå³å®šæ—¶ä»»åŠ¡

åœ¨srcæ–°å»ºä¸€ä¸ªutils > copy.sh å†™å…¥shå‘½ä»¤ã€‚æ‰§è¡Œsh copy.sh,åœ¨ä¸Šå°èŠ‚åˆ›å»ºçš„logsä¼šå¤šå‡ºä¸€ä¸ªæ–‡ä»¶åä¸º2019-09-17.access.log æ–‡ä»¶åå³å®Œæˆæ—¥å¿—æ‹†åˆ†ã€‚ä¸‹é¢æ˜¯shå‘½ä»¤ï¼š
```
!/bin/sh
cd /Users/wusimin7/Documents/jd_code/node-blog/blog-node/logs
cp access.log $(date +%Y-%m-%d).access.log
echo "" > access.log

```
åœ¨æˆ‘ä»¬çš„æ€»é¡¹ç›®ä¸‹æ‰§è¡Œcrontab -e åˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‚è¾“å…¥ä»¥ä¸‹å†…å®¹ã€‚wq!ä¿å­˜åé€šè¿‡crontab -l æŸ¥çœ‹åˆšåˆ›å»ºçš„crontabå‘½ä»¤ã€‚
> *0 * * * sh /Users/wusimin7/Documents/jd_code/node-blog/blog-node/src/utils/copy.sh

## äº”ã€åšå®¢é¡¹ç›®ä¹‹å®‰å…¨
å®‰å…¨æ˜¯ server ç«¯éœ€è¦è€ƒè™‘çš„é‡ç‚¹å†…å®¹ï¼Œæœ¬ç« ä¸»è¦è®²è§£ nodejs å¦‚ä½•é˜²èŒƒ sql æ³¨å…¥ï¼Œxss æ”»å‡»ï¼Œä»¥åŠæ•°æ®åº“çš„å¯†ç åŠ å¯† â€”â€” ä»¥é˜²è¢«é»‘å®¢è·å–æ˜æ–‡å¯†ç ã€‚
### 1. sqlæ³¨å…¥
* æœ€åŸå§‹ã€æœ€ç®€å•çš„æ”»å‡»
* æ”»å‡»æ–¹æ³•ï¼šè¾“å…¥ä¸€ä¸ªsqlç‰‡æ®µï¼Œæœ€ç»ˆæ‹¼æ¥æˆä¸€æ®µæ”»å‡»ä»£ç 
* é¢„é˜²é”™è¯¯ï¼šä½¿ç”¨mysqlçš„ escape å‡½æ•°å¤„ç†è¾“å…¥å†…å®¹(ä»serverç«¯è€ƒè™‘)

æ”»å‡»æ–¹æ³•æ¼”ç¤ºï¼š ğŸ‘‰
åœ¨æˆ‘ä»¬çš„sqlä¸­è¾“å…¥
> select username, realname from users where username='zhangsan'-- and password="123";

è¿™ä¸ªsqlè¯­å¥ä¸­èƒ½æŸ¥å‡ºç”¨æˆ·å"zhangsan",å¯†ç å°±ä¸ä¼šæ˜¾ç¤ºï¼Œè¢« -- æ‰€æ³¨é‡Šäº†ã€‚åˆ©ç”¨è¿™ä¸ªå°±å¯ä»¥è¿›è¡Œsqlæ³¨å…¥æ”»å‡»äº†
![sqlæ³¨å…¥æ”»å‡»](https://user-gold-cdn.xitu.io/2019/9/20/16d4c663eeb710a7?w=926&h=96&f=png&s=15120)
ä½ ä¼šå‘ç°åªè¾“å…¥ç”¨æˆ·åä¹Ÿèƒ½ç™»å…¥ã€‚è¿™å°±æ˜¯ç®€å•çš„sqlæ³¨å…¥æ”»å‡»äº†ã€‚å½“ç„¶è¿™ä¸ªè·Ÿä½ ç™»å½•æŸ¥è¯¢çš„sqlè¯­å¥æœ‰å…³ã€‚

escape å‡½æ•°é¢„é˜² ğŸ‘‰ åˆ©ç”¨mysqlä¸­çš„escapeå‡½æ•°åŒ…è£¹æˆ‘ä»¬çš„ç™»å½•åå’Œå¯†ç 
```
//  dbæ–‡ä»¶å¤¹ä¸‹å¯¼å‡ºescapeå‡½æ•°ã€‚åœ¨user.jsä¸­å¼•ç”¨
escape: mysql.escape

username = escape(username)
password = escape(password)
```
### 2. xssæ”»å‡»
* æ”»å‡»æ–¹å¼ï¼š åœ¨é¡µé¢å±•ç¤ºçš„å†…å®¹ä¸­æºæ‚jsä»£ç ï¼Œä»¥è·å–ç½‘é¡µä¿¡æ¯
* é¢„é˜²æªæ–½ï¼š è½¬æ¢ç”Ÿæˆjsçš„ç‰¹æ®Šå­—ç¬¦,ï¼ˆnpm install xss -d --saveï¼‰

æ”»å‡»æ–¹æ³•æ¼”ç¤ºï¼š ğŸ‘‰
åœ¨æ–°å»ºåšå®¢çš„æ—¶å€™æ ‡é¢˜è¾“å…¥ä¸‹é¢å†…å®¹å³å¯æŸ¥çœ‹æœ¬ç½‘ç«™çš„cookieã€‚
```
<script>alert(document.cookie)</script>
```
### 3. å¯†ç åŠ å¯†
åœ¨utils > crpy.js åŠ å¯†æ–‡ä»¶
```
const crypto = require('crypto')

// å¯†åŒ™
const SECRET_KEY = 'WJiol_8776#'

// md5 åŠ å¯†
function md5(content) {
  let md5 = crypto.createHash('md5')
  return md5.update(content).digest('hex')
}

// åŠ å¯†å‡½æ•°
function genPassword(password) {
  const str = `password=${password}&key=${SECRET_KEY}`
  return md5(str)
}
module.exports = {
  genPassword
}
```
åœ¨controller > user.jsä¸­å¼•å…¥genPasswordæ–¹æ³•å¯¹è¾“å…¥çš„å¯†ç åŠ å¯†
> password = genPassword(password)
## å…­ã€ä½¿ç”¨ express é‡æ„åšå®¢é¡¹ç›®
### expresså®‰è£…ï¼ˆä½¿ç”¨è„šæ‰‹æ¶express-generatorï¼‰
> npm install express-generator -g

é€šè¿‡ express express-test å‘½ä»¤ç”Ÿæˆä¸€ä¸ªé¡¹ç›®ã€‚npm install å»ä¸‹è½½ä¾èµ–åŒ…è¿è¡Œnpm start è®¿é—®localhist:3000ã€‚å†å®‰è£…ç›‘å¬æ–‡ä»¶çš„ä¿®æ”¹
> npm install nodemon cross-env --save-dev

å†package.jsonæ–°å¢ä¸€ä¸ªscriptså‘½ä»¤: 
> "dev": "cross-env NODE_ENV=dev nodemon ./bin/www"

### expressä¸­app.jsä»‹ç»
1. http-errors å¤„ç†404
2. cookie-parser è§£æcookie
3. morgan è‡ªåŠ¨ç”Ÿæˆæ—¥å¿—
4. app.use(express.json()); å¤„ç†post data
5. app.use(express.urlencoded({ extended: false })); postå…¼å®¹å…¶ä»–æ ¼å¼

### expressä¸­é—´ä»¶
æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼šrepress-testï¼Œåˆå§‹åŒ–npm init -yï¼Œå®‰è£…expressï¼š npm i expressã€‚æ–°å»ºä¸€ä¸ªapp.jsã€‚[app.jsä¸­çš„ä»£ç ](https://github.com/WsmDyj/node-blog/blob/express/express-test/app.js)ã€‚é€šè¿‡next()é“¾å¼è°ƒç”¨ï¼Œå®ç°expressä¸­é—´ä»¶çš„æ‰§è¡Œè¿‡ç¨‹
### expresså¼€å‘æ¥å£
 * å®‰è£…æ’ä»¶ mysql xss  >  npm i mysql xss --save -d
 * mysql controller resModelç›¸å…³ä»£ç å¯ä»¥å¤ç”¨
 * åˆå§‹åŒ–è·¯ç”±
## ä¸ƒã€ä½¿ç”¨ Koa2 é‡æ„åšå®¢é¡¹ç›®
## å…«ã€ä¸Šçº¿ä¸é…ç½®